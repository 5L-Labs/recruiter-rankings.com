<% content_for :title, "#{@recruiter.name} — Recruiter Profile" %>
<% content_for :meta_description, "Aggregated reviews and metrics for #{@recruiter.name}." %>

<nav aria-label="<%= t('recruiters.show.breadcrumb_aria', default: 'Breadcrumb') %>" style="margin-bottom: 16px;">
  <%= link_to "← #{t('recruiters.index.title', default: 'Top Recruiters')}", recruiters_path, class: "muted", style: "text-decoration: none; font-size: 0.9em;" %>
</nav>

<h1><%= @recruiter.name %></h1>
<p><strong>Company:</strong> <% if @recruiter.company %><%= link_to @recruiter.company.name, company_path(@recruiter.company) %><% else %>—<% end %></p>
<p><strong>Region:</strong> <%= @recruiter.region || "—" %></p>
<p><strong>Verified:</strong> <%= @recruiter.verified_at ? @recruiter.verified_at.strftime("%Y-%m-%d") : "No" %></p>

<% last_challenge = @recruiter.identity_challenges.order(created_at: :desc).first %>
<% if last_challenge && !last_challenge.verified_at && last_challenge.last_verification_error.present? %>
  <div class="alert alert-danger">
    <strong>Verification Failed:</strong> <%= last_challenge.last_verification_error %>
    <p>Please <a href="<%= new_claim_identity_path(subject_type: 'recruiter', recruiter_slug: @recruiter.public_slug) %>">try again</a>.</p>
  </div>
<% end %>

<section>
  <h2><%= t('recruiters.show.aggregates') %></h2>
  <p><strong><%= t('recruiters.show.average_overall') %>:</strong> <%= @avg_overall&.round(2) || "—" %> (<%= @reviews_count %> <%= t('recruiters.index.th.reviews') %>)</p>
  <ul>
    <% ReviewMetric::DIMENSIONS.each do |k, v| %>
      <li><%= v.humanize %>: <%= (@dimension_averages[k.to_s]&.to_f&.round(2) || "—") %></li>
    <% end %>
  </ul>
</section>

<div style="display: flex; gap: 16px; align-items: center; margin: 24px 0;">
  <%= link_to t('recruiters.show.write_review'),
      new_recruiter_review_path(@recruiter.public_slug, recruiter_slug: @recruiter.public_slug),
      class: "cta",
      style: "margin-top: 0;",
      aria: { label: t('reviews.new.title_for', name: @recruiter.name) }
  %>

  <%= link_to t('recruiters.show.claim_profile'),
      new_claim_identity_path(subject_type: 'recruiter', recruiter_slug: @recruiter.public_slug),
      class: "muted",
      style: "text-decoration: underline;"
  %>
</div>

<section>
  <h2><%= t('recruiters.show.recent_reviews') %></h2>
  <% @reviews.each do |rev| %>
    <article style="border:1px solid var(--border); padding:10px; margin-bottom:10px; background: var(--surface);">
      <p><strong>Overall:</strong> <%= rev.overall_score %> — <em><%= rev.created_at.strftime("%Y-%m-%d") %></em></p>
      <p class="review-text"><%= simple_format rev.text %></p>
      <%# Performance: Use eager-loaded visible_review_responses to avoid N+1 queries %>
      <% if rev.visible_review_responses.present? %>
        <div style="margin-top:8px; padding:8px; border-left:3px solid var(--accent); background: transparent;">
          <p style="margin:0 0 4px 0; color: var(--muted);"><strong>Right-of-reply</strong></p>
          <% rev.visible_review_responses.each do |resp| %>
            <p style="margin:0 0 8px 0;">
              <%= simple_format resp.body %>
              <small style="color: var(--muted);">— posted <%= time_ago_in_words(resp.created_at) %> ago</small>
            </p>
          <% end %>
        </div>
      <% end %>
    </article>
  <% end %>
</section>
